<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShareU - The Shortener</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ”—</text></svg>">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a;
            color: #f3f4f6;
        }
        .bg-card {
            background-color: #2c2c2c;
        }
        .text-primary {
            color: #ffffff;
        }
        .text-secondary {
            color: #d1d5db;
        }
        .border-input {
            border-color: #4a4a4a;
        }
        .focus-ring-blue {
            --tw-ring-color: #3b82f6;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Main container (Main UI) -->
    <div id="main-ui" class="container mx-auto p-4 flex-grow flex flex-col items-center justify-center">

        <!-- Main Content (Link Shortener) -->
        <div class="bg-card p-8 md:p-12 rounded-2xl shadow-xl w-full max-w-2xl text-center transition-all duration-300 transform scale-100 opacity-100 flex flex-col items-center">
            <h1 class="text-5xl font-extrabold mb-4 text-primary">The Ultimate Link Shortener</h1>
            <p class="text-xl text-secondary mb-4 max-w-lg">ShareU helps you shorten your long links into easy-to-share links. It's fast, free, and secure.</p>
            <p class="text-lg text-secondary mb-8 max-w-lg">Start joining us and enjoy the features we have provided just for you!</p>

            <!-- URL Input and Button -->
            <div class="flex flex-col md:flex-row gap-4 mb-6 w-full">
                <input type="url" id="long-url-input" placeholder="Enter your long URL here..." class="flex-grow p-4 rounded-xl border border-input bg-card text-white focus:outline-none focus:ring-2 focus:focus-ring-blue transition-all duration-300">
                <button id="shorten-button" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 px-8 rounded-xl transition-colors duration-300 whitespace-nowrap">
                    Create Link
                </button>
            </div>

            <!-- Short Link and Copy Button -->
            <div id="result-container" class="hidden flex flex-col md:flex-row gap-4 items-center justify-center bg-gray-700 p-4 rounded-xl border border-gray-600 w-full">
                <div id="short-url-output" class="flex-grow text-gray-200 p-2 break-all font-mono text-lg text-left"></div>
                <button id="copy-button" class="bg-green-500 hover:bg-green-600 text-white py-2 px-6 rounded-lg transition-colors duration-300">
                    Copy
                </button>
            </div>
        </div>

        <!-- About Section -->
        <div class="bg-card p-8 md:p-12 rounded-2xl shadow-xl w-full max-w-2xl mt-8">
            <h2 class="text-3xl font-bold mb-4 text-primary text-center">About This Web</h2>
            <p class="text-secondary text-center mb-4">This website is designed for educational purposes to demonstrate link shortening technology and its core functionalities, including user authentication and data storage using Firebase. It also showcases how to implement dynamic content and a basic security warning system for URLs.</p>
            <p class="text-secondary text-center">Created by: Gemini AI</p>
        </div>

        <!-- Link History Section -->
        <div class="bg-card p-8 md:p-12 rounded-2xl shadow-xl w-full max-w-2xl mt-8">
            <h2 class="text-3xl font-bold mb-4 text-primary text-center">Link History</h2>
            <ul id="history-list" class="flex flex-col gap-3">
                <!-- Link history will be populated here by JavaScript -->
            </ul>
        </div>

    </div>
    
    <!-- Redirect and Warning UI -->
    <div id="redirect-ui" class="hidden fixed inset-0 flex flex-col lg:flex-row items-center justify-center text-center bg-gray-900 bg-opacity-90 z-50 p-4 gap-8">
        
        <!-- Redirect Content (Left Side) -->
        <div class="w-full lg:w-2/3 flex flex-col items-center justify-center bg-card p-8 rounded-2xl shadow-xl">
            <h1 class="text-4xl font-bold mb-4 text-primary" id="redirect-title">Creating Download Link</h1>
            <p class="text-lg text-secondary mb-4" id="redirect-message">Please wait 15 seconds...</p>
            <div id="redirect-countdown" class="text-6xl font-bold text-blue-600 my-4">15</div>
            <button id="go-link-button" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-4 px-8 rounded-xl transition-colors duration-300 hidden mt-4">
                Go Link
            </button>
        </div>

        <!-- Blog Breaking News & Ads (Right Side) -->
        <div class="w-full lg:w-1/3 flex flex-col gap-8">
            <!-- Google AdSense Automatic Ad Placeholder -->
            <div class="w-full text-center bg-card p-4 rounded-xl shadow-xl border border-gray-600">
                <p class="text-sm text-gray-400">Google AdSense Automatic Ad Placeholder</p>
                <div class="h-24 bg-gray-700 rounded mt-2 flex items-center justify-center">
                    <span class="text-gray-500">Ad Space</span>
                </div>
            </div>

            <!-- Blog Breaking News -->
            <div class="bg-card p-6 rounded-2xl shadow-xl">
                <h2 class="text-2xl font-bold mb-4 text-primary">Breaking News</h2>
                <div id="news-list" class="flex flex-col gap-4">
                    <div class="p-3 bg-gray-700 rounded-lg">
                        <h3 class="font-semibold text-lg text-white">Gemini Launches New Version</h3>
                        <p class="text-sm text-gray-400">Google announced the latest version of their language model, promising improved performance and efficiency.</p>
                        <a href="#" class="text-blue-400 text-sm mt-1 inline-block hover:underline">Read More</a>
                    </div>
                    <div class="p-3 bg-gray-700 rounded-lg">
                        <h3 class="font-semibold text-lg text-white">New Smartphone Launched</h3>
                        <p class="text-sm text-gray-400">A leading tech company has launched its latest flagship product with innovative features.</p>
                        <a href="#" class="text-blue-400 text-sm mt-1 inline-block hover:underline">Read More</a>
                    </div>
                    <div class="p-3 bg-gray-700 rounded-lg">
                        <h3 class="font-semibold text-lg text-white">AI Trends in Daily Life</h3>
                        <p class="text-sm text-gray-400">An in-depth analysis of how artificial intelligence is becoming integrated into various aspects of our lives.</p>
                        <a href="#" class="text-blue-400 text-sm mt-1 inline-block hover:underline">Read More</a>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Security Warning UI -->
    <div id="warning-ui" class="hidden fixed inset-0 flex items-center justify-center text-center bg-gray-900 bg-opacity-90 z-50 p-4">
        <div class="bg-red-800 p-8 md:p-12 rounded-2xl shadow-xl w-full max-w-2xl text-white">
            <h1 class="text-4xl font-bold mb-4">This Website Might Be Dangerous</h1>
            <p class="text-lg text-red-200 mb-4">Chrome might have blocked this site because it contains potentially harmful content, such as phishing scams, malware, or spam.</p>
            <div id="warning-details" class="bg-red-700 p-4 rounded-lg text-left text-sm hidden">
                <h3 class="font-semibold mb-2">Details:</h3>
                <ul class="list-disc list-inside space-y-1">
                    <li>This URL has been flagged as suspicious by our security database.</li>
                    <li>It may try to steal your personal information or install unwanted software.</li>
                    <li>We recommend you do not proceed.</li>
                </ul>
            </div>
            <button id="show-details-button" class="mt-6 bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-6 rounded-lg transition-colors duration-300">
                Show Details
            </button>
            <div class="flex flex-col sm:flex-row justify-center gap-4 mt-4">
                <button id="go-back-button" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-6 rounded-lg transition-colors duration-300">
                    Go Back
                </button>
                <button id="proceed-button" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-6 rounded-lg transition-colors duration-300">
                    Proceed Anyway
                </button>
            </div>
        </div>
    </div>

    <!-- Custom Message Box -->
    <div id="message-box" class="fixed bottom-4 right-4 bg-gray-800 text-white p-4 rounded-lg shadow-lg z-50 transform translate-y-full opacity-0 transition-all duration-500 ease-in-out">
        <p id="message-text"></p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDocs, collection, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        
        setLogLevel('debug');

        let app;
        let db;
        let auth;
        let userId = null;
        let authReady = false;
        
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAlGXpZSyQab7riDteV5ppS3DXDJQHywKw",
            authDomain: "modmanagerpro-248f5.firebaseapp.com",
            projectId: "modmanagerpro-248f5",
            storageBucket: "modmanagerpro-248f5.firebasestorage.app",
            messagingSenderId: "594650288669",
            appId: "1:594650288669:web:3308b084911e2ef7f1ecf4",
            measurementId: "G-TE9234E3LP"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- UI Elements ---
        const mainUI = document.getElementById('main-ui');
        const redirectUI = document.getElementById('redirect-ui');
        const warningUI = document.getElementById('warning-ui');
        const longUrlInput = document.getElementById('long-url-input');
        const shortenButton = document.getElementById('shorten-button');
        const resultContainer = document.getElementById('result-container');
        const shortUrlOutput = document.getElementById('short-url-output');
        const copyButton = document.getElementById('copy-button');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const goLinkButton = document.getElementById('go-link-button');
        const showDetailsButton = document.getElementById('show-details-button');
        const warningDetails = document.getElementById('warning-details');
        const goBackButton = document.getElementById('go-back-button');
        const proceedButton = document.getElementById('proceed-button');
        const historyList = document.getElementById('history-list');

        // --- Utility Functions ---
        function showMessage(text) {
            messageText.textContent = text;
            messageBox.classList.remove('translate-y-full', 'opacity-0');
            messageBox.classList.add('translate-y-0', 'opacity-100');
            setTimeout(() => {
                messageBox.classList.remove('translate-y-0', 'opacity-100');
                messageBox.classList.add('translate-y-full', 'opacity-0');
            }, 3000);
        }

        function startCountdown(duration, onTick, onComplete) {
            let timer = duration;
            document.getElementById('redirect-countdown').textContent = timer;
            const interval = setInterval(() => {
                timer--;
                document.getElementById('redirect-countdown').textContent = timer;
                if (timer <= 0) {
                    clearInterval(interval);
                    onComplete();
                }
            }, 1000);
        }

        // --- Firebase Initialization ---
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            const analytics = getAnalytics(app);

            // Handle authentication
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    authReady = true;
                    console.log("Signed in. User ID:", userId);
                    handleUrlPath();
                    setupRealtimeHistory();
                } else {
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Failed to sign in anonymously:", error);
                        showMessage("Failed to sign in. Please try again later.");
                    }
                }
            });
        } catch (e) {
            console.error("Firebase initialization failed:", e);
            showMessage("Sorry, the application could not connect. Please try again later.");
        }

        // --- Demo Blacklist for Warning System ---
        const blockedSites = [
            'phishing-demo.com',
            'malware-example.org'
        ];
        
        // --- Link History Functionality ---
        function setupRealtimeHistory() {
            const linksCollection = collection(db, `artifacts/${appId}/public/data/short_urls`);
            const q = query(linksCollection);

            onSnapshot(q, (snapshot) => {
                historyList.innerHTML = ''; // Clear existing list
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const fullShortUrl = `https://${window.location.hostname}/${data.shortCode}`;
                    const listItem = document.createElement('li');
                    listItem.className = "bg-gray-700 p-3 rounded-lg flex flex-col sm:flex-row justify-between items-center break-all";
                    listItem.innerHTML = `
                        <div class="flex flex-col text-left">
                            <span class="text-sm text-gray-400">Original Link:</span>
                            <a href="${data.longUrl}" target="_blank" class="text-white text-sm hover:underline">${data.longUrl}</a>
                        </div>
                        <div class="flex flex-col text-right mt-2 sm:mt-0">
                            <span class="text-sm text-gray-400">Short Link:</span>
                            <a href="${fullShortUrl}" target="_blank" class="text-blue-400 font-mono hover:underline">${fullShortUrl}</a>
                        </div>
                    `;
                    historyList.appendChild(listItem);
                });
            }, (error) => {
                console.error("Error fetching link history: ", error);
                showMessage("Failed to load link history.");
            });
        }

        // --- URL Handling and Redirect Flow ---
        async function handleUrlPath() {
            if (!authReady) {
                return;
            }

            const path = window.location.pathname.substring(1);
            if (path && path.length > 0) {
                mainUI.classList.add('hidden');
                
                try {
                    const linksCollection = collection(db, `artifacts/${appId}/public/data/short_urls`);
                    const q = query(linksCollection, where('shortCode', '==', path));
                    const querySnapshot = await getDocs(q);

                    if (!querySnapshot.empty) {
                        const docData = querySnapshot.docs[0].data();
                        const longUrl = docData.longUrl;
                        if (longUrl) {
                            const urlHost = new URL(longUrl).hostname;
                            const isBlocked = blockedSites.some(site => urlHost.includes(site));

                            if (isBlocked) {
                                showWarningPage(longUrl);
                            } else {
                                startRedirectFlow(longUrl);
                            }
                        } else {
                            window.location.href = window.location.origin;
                        }
                    } else {
                        window.location.href = window.location.origin;
                    }
                } catch (e) {
                    console.error("Error fetching document: ", e);
                    window.location.href = window.location.origin;
                }
            } else {
                mainUI.classList.remove('hidden');
                redirectUI.classList.add('hidden');
                warningUI.classList.add('hidden');
            }
        }

        function startRedirectFlow(longUrl) {
            redirectUI.classList.remove('hidden');
            redirectUI.classList.add('flex');
            document.getElementById('redirect-title').textContent = "Creating Download Link";
            document.getElementById('redirect-message').textContent = "Please wait 15 seconds...";
            goLinkButton.classList.add('hidden');

            startCountdown(15, () => {}, () => {
                document.getElementById('redirect-title').textContent = "Link Ready!";
                document.getElementById('redirect-message').textContent = "Please click the button below to proceed.";
                goLinkButton.classList.remove('hidden');
            });

            goLinkButton.onclick = () => {
                window.location.href = longUrl;
            };
        }

        function showWarningPage(longUrl) {
            warningUI.classList.remove('hidden');
            warningUI.classList.add('flex');
            
            showDetailsButton.onclick = () => {
                warningDetails.classList.toggle('hidden');
                if (warningDetails.classList.contains('hidden')) {
                    showDetailsButton.textContent = "Show Details";
                } else {
                    showDetailsButton.textContent = "Hide Details";
                }
            };
            
            goBackButton.onclick = () => {
                window.location.href = window.location.origin;
            };

            proceedButton.onclick = () => {
                window.location.href = longUrl;
            };
        }

        // --- Link Shortener Logic ---
        shortenButton.addEventListener('click', async () => {
            if (!authReady) {
                showMessage("App is loading, please wait a moment.");
                return;
            }
            const longUrl = longUrlInput.value.trim();
            if (!longUrl) {
                showMessage("Please enter a valid URL.");
                return;
            }
            
            shortenButton.disabled = true;
            showMessage("Creating link, please wait...");
            
            const urlWithProtocol = longUrl.startsWith('http://') || longUrl.startsWith('https://') ? longUrl : `https://${longUrl}`;
            
            try {
                const shortCode = Math.random().toString(36).substring(2, 8);
                const linksCollection = collection(db, `artifacts/${appId}/public/data/short_urls`);
                
                await setDoc(doc(linksCollection, shortCode), {
                    longUrl: urlWithProtocol,
                    shortCode: shortCode,
                    createdAt: new Date(),
                    createdBy: userId
                });
                
                const fullShortUrl = `https://${window.location.hostname}/${shortCode}`;
                shortUrlOutput.textContent = fullShortUrl;
                resultContainer.classList.remove('hidden');
                resultContainer.classList.add('flex');
                
                longUrlInput.value = "";
                shortenButton.disabled = false;
                showMessage("Link successfully created!");

            } catch (e) {
                console.error("Error adding document: ", e);
                showMessage("Failed to create link. Please try again.");
                shortenButton.disabled = false;
            }
        });

        // --- Copy Link Logic ---
        copyButton.addEventListener('click', () => {
            const urlToCopy = shortUrlOutput.textContent;
            const tempInput = document.createElement('textarea');
            tempInput.value = urlToCopy;
            document.body.appendChild(tempInput);
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            showMessage("Link copied!");
        });

    </script>
</body>
</html>
