<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShareU - Advanced Link Shortener</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
:root {
    /* Primary Colors */
    --color-primary: #2563eb; /* Indigo-Blue */
    --color-secondary: #22d3ee; /* Cyan */
    --color-success: #22c55e; /* Green */
    --color-text-dark: #222;
    --color-text-light: #f3f6fa;

    /* Backgrounds (Light Mode) */
    --bg-body-start: #e0e7ff;
    --bg-body-end: #f0f2f5;
    --bg-card: #fff;
    --bg-input: #f3f6fa;
    --bg-nav-btn: #f3f6fa;

    /* Shadow/Box Styling */
    --shadow-card: 0 12px 40px 0 rgba(50,60,90,0.15);
    --shadow-input: 0 1px 3px rgba(90,120,150,0.06);
    --border-radius-main: 24px;
    --border-radius-sm: 16px;
}

/* DARK MODE VARIABLES */
body.dark-mode {
    --bg-body-start: #101828;
    --bg-body-end: #1f2937;
    --bg-card: #16213d;
    --bg-input: #1a2336;
    --bg-nav-btn: #1a2336;
    --color-primary: #38bdf8; /* Lighter blue for better contrast in dark mode */
    --color-secondary: #2563eb;
    --color-text-dark: #f3f6fa;
    --shadow-card: 0 12px 40px 0 rgba(0,0,0,0.30); /* Darker shadow for depth */
}
    </style>
</head>
<body class="flex flex-col min-h-screen">
    
    <div id="global-warning-ui" class="hidden bg-yellow-500 text-white p-3 text-center sticky top-0 z-50">
        <p id="global-warning-text" class="font-semibold"></p>
    </div>

    <header class="container-bg custom-shadow sticky top-0 z-50">
        <nav class="max-w-4xl mx-auto flex flex-col md:flex-row items-center justify-between p-4">
            <div class="flex items-center gap-2">
                <img src="https://iili.io/KFlsOAX.png" alt="ShareU Logo" class="h-10">
                <h1 class="text-2xl font-bold text-gray-800">ShareU</h1>
            </div>
            <div class="flex gap-1 p-1 bg-gray-100 rounded-full mt-4 md:mt-0">
                <button class="nav-btn font-medium text-gray-600 px-4 py-2 rounded-full hover:bg-white hover:text-blue-600 transition-colors duration-200" data-page="shortener">Shortener</button>
                <button class="nav-btn font-medium text-gray-600 px-4 py-2 rounded-full hover:bg-white hover:text-blue-600 transition-colors duration-200" data-page="history">History</button>
                <button class="nav-btn font-medium text-gray-600 px-4 py-2 rounded-full hover:bg-white hover:text-blue-600 transition-colors duration-200" data-page="forum">Forum</button>
                <button class="nav-btn font-medium text-gray-600 px-4 py-2 rounded-full hover:bg-white hover:text-blue-600 transition-colors duration-200" data-page="friends">Friends</button>
                <button class="nav-btn font-medium text-gray-600 px-4 py-2 rounded-full hover:bg-white hover:text-blue-600 transition-colors duration-200" data-page="chat-admin">Chat Admin</button>
                <button class="nav-btn font-medium text-gray-600 px-4 py-2 rounded-full hover:bg-white hover:text-blue-600 transition-colors duration-200" data-page="about">About</button>
                <button class="nav-btn font-medium text-gray-600 px-4 py-2 rounded-full hover:bg-white hover:text-blue-600 transition-colors duration-200" data-page="settings"><i class="fa-solid fa-gear"></i></button>
                <button id="admin-nav-btn" class="nav-btn hidden font-medium text-white px-4 py-2 rounded-full bg-red-600 hover:bg-red-700 transition-colors duration-200" data-page="admin"><i class="fa-solid fa-user-shield"></i> Admin</button>
            </div>
        </nav>
    </header>

    <main class="flex-grow flex flex-col items-center justify-center p-4">
        <div id="loading-spinner" class="hidden fixed inset-0 flex flex-col items-center justify-center text-gray-500 bg-white bg-opacity-70 z-[102]">
            <i class="fa-solid fa-spinner fa-spin-pulse text-4xl mb-2"></i>
            <p>Loading...</p>
        </div>
        
        <div id="maintenance-ui" class="hidden fixed inset-0 flex items-center justify-center text-center bg-gray-900 bg-opacity-95 z-[101] p-4">
            <div class="bg-red-700 p-12 rounded-3xl custom-shadow w-full max-w-lg text-white">
                <i class="fa-solid fa-triangle-exclamation text-6xl mb-4"></i>
                <h1 class="text-3xl font-bold mb-4">Site Under Maintenance</h1>
                <p class="text-lg text-red-100">Our service is currently undergoing scheduled maintenance. Please check back later.</p>
            </div>
        </div>

        <div id="shortener-page" class="page-content container-bg p-8 md:p-12 rounded-3xl custom-shadow w-full max-w-2xl">
            <h2 class="text-3xl font-bold text-center mb-8 text-gray-800">Shorten Your Link</h2>
            
            <div class="space-y-6">
                <div class="form-group">
                    <label for="long-url-input" class="block text-sm font-medium text-gray-700 mb-2">Shortening Type</label>
                    <div class="flex items-center gap-4">
                        <div id="shorten-type-slider" class="slider-container flex-grow">
                            <div class="slider-thumb flex items-center justify-center font-semibold text-white bg-green-500">
                                <i class="fa-solid fa-check mr-2"></i> Basic Shorten
                            </div>
                        </div>
                        <i class="fa-solid fa-circle-info text-gray-500 cursor-pointer" title="Basic: Direct 15s redirect. Iframe: 15s redirect then load URL in an iframe with a footer ad. Check About for details."></i>
                    </div>
                </div>

                <div class="form-group">
                    <label for="long-url-input" class="block text-sm font-medium text-gray-700">Long URL</label>
                    <input type="url" id="long-url-input" placeholder="https://example.com/very-long-link" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="form-group">
                    <label for="custom-domain-input" class="block text-sm font-medium text-gray-700">Custom Domain (Optional)</label>
                    <div class="mt-1 flex items-center">
                        <span class="text-gray-500 mr-2">/</span>
                        <input type="text" id="custom-domain-input" placeholder="my-custom-link" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <span id="domain-status" class="ml-2 text-xl"></span>
                    </div>
                    <div id="suggestion-container" class="mt-2 text-sm text-gray-600 hidden flex flex-col gap-2">
                        <p>Suggestion:</p>
                        <div id="suggestion-list" class="flex flex-wrap gap-2"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="expiry-date-input" class="block text-sm font-medium text-gray-700">Expiry Date (Optional)</label>
                    <input type="date" id="expiry-date-input" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button id="shorten-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 px-4 rounded-xl transition-colors duration-200 custom-shadow">
                    Shorten
                </button>
            </div>
            
            <div id="result-container" class="hidden mt-6 bg-blue-50 p-4 rounded-xl border border-blue-200">
                <div class="flex flex-col md:flex-row items-center gap-4">
                    <div id="short-url-output" class="flex-grow text-blue-800 p-2 break-all font-mono text-lg font-semibold"></div>
                    <div class="flex flex-col sm:flex-row gap-2 mt-4 sm:mt-0">
                        <button id="copy-button" class="bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center gap-2">
                            <i class="fa-solid fa-copy"></i> Copy Link
                        </button>
                        <button id="download-qr-button" class="bg-purple-500 hover:bg-purple-600 text-white py-2 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center gap-2">
                            <i class="fa-solid fa-qrcode"></i> Download QR
                        </button>
                    </div>
                </div>
                <div id="qrcode-container" class="mt-4 flex justify-center"></div>
            </div>
        </div>

        <div id="history-page" class="page-content hidden w-full max-w-2xl">
            <div class="container-bg p-8 md:p-12 rounded-3xl custom-shadow w-full">
                <h2 class="text-3xl font-bold text-center mb-6">Link History</h2>
                <div id="loading-history" class="text-center text-gray-500">Loading history...</div>
                <div id="history-list" class="space-y-4"></div>
            </div>
        </div>

        <div id="forum-page" class="page-content hidden w-full max-w-2xl">
            <div class="container-bg p-8 md:p-12 rounded-3xl custom-shadow w-full">
                <h2 class="text-3xl font-bold text-center mb-6">Forum</h2>
                <div id="forum-posts" class="space-y-6"></div>
                <div class="mt-6">
                    <h3 class="font-bold text-lg mb-2">Create a New Post</h3>
                    <textarea id="forum-input" rows="4" class="block w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Write your post here..."></textarea>
                    <button id="post-button" class="mt-3 w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-xl transition-colors duration-200">Post</button>
                </div>
            </div>
        </div>
        
        <div id="friends-page" class="page-content hidden w-full max-w-2xl">
            <div class="container-bg p-8 md:p-12 rounded-3xl custom-shadow w-full">
                <h2 class="text-3xl font-bold text-center mb-6">Friends List</h2>
                <div class="space-y-4">
                    <p class="text-gray-600 text-center">This feature is currently under development. You will be able to add and manage friends here.</p>
                    <div class="flex gap-2">
                        <input type="text" placeholder="Enter Friend's User ID (e.g., uYF...) or Short Code" class="flex-grow p-3 border border-gray-300 rounded-lg">
                        <button class="bg-green-500 hover:bg-green-600 text-white py-3 px-4 rounded-xl">Add Friend</button>
                    </div>
                    <ul class="mt-6 space-y-3" id="friend-list">
                        </ul>
                </div>
            </div>
        </div>

        <div id="chat-admin-page" class="page-content hidden w-full max-w-2xl">
            <div class="container-bg p-8 md:p-12 rounded-3xl custom-shadow w-full">
                <h2 class="text-3xl font-bold text-center mb-6">Chat Admin</h2>
                <p id="chat-status" class="text-center text-sm mb-4 text-red-500 hidden font-semibold">You are permanently banned from using Chat Admin due to violating the toxicity policy.</p>
                <div id="chat-window" class="h-80 overflow-y-auto border border-gray-300 p-4 rounded-lg space-y-3 bg-gray-100 mb-4">
                    </div>
                <div class="flex gap-2">
                    <input type="text" id="chat-input" placeholder="Type your message..." class="flex-grow p-3 border border-gray-300 rounded-lg">
                    <button id="send-chat-button" class="bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-xl">Send</button>
                </div>
                <p id="chat-cooldown-text" class="text-sm text-gray-500 mt-2">Cooldown: 5s per message.</p>
            </div>
        </div>

        <div id="about-page" class="page-content hidden w-full max-w-2xl">
            <div class="container-bg p-8 md:p-12 rounded-3xl custom-shadow w-full">
                <h2 class="text-3xl font-bold text-center mb-6">About ShareU</h2>
                <p class="text-gray-700 leading-relaxed text-center mb-6">ShareU is a modern URL shortening service designed to provide more than just a short link. It offers features like custom domains, link expiration, and QR code generation. Built for educational purposes, it showcases advanced web development techniques including real-time database integration with Firestore and responsive design.</p>
                
                <h3 class="text-xl font-semibold mb-2 text-blue-600">Shortening Types</h3>
                <div class="space-y-4 text-gray-700">
                    <p><strong>Basic Shorten:</strong> The standard link shortening. The user is redirected to a verification page, waits 15 seconds, and then is redirected directly to the target URL.</p>
                    <p><strong>Iframe Shorten:</strong> The user is redirected to a verification page, waits 15 seconds, and then the target URL is loaded within an **iframe** on a ShareU page. A footbar advertising ShareU is displayed at the bottom of the screen.</p>
                    <p class="font-bold text-red-600">⚠️ Iframe Warning: Not all websites permit being loaded in an iframe (using the `X-Frame-Options` or `Content-Security-Policy` headers). Iframe Shorten is recommended only for mid-to-low-tier websites where iframe embedding is typically allowed.</p>
                </div>

                <div class="mt-6 text-center text-sm text-gray-500">
                    <p>Your User ID: <span id="user-id-span" class="font-mono">Loading...</span></p>
                </div>
            </div>
        </div>

        <div id="settings-page" class="page-content hidden w-full max-w-2xl">
            <div class="container-bg p-8 md:p-12 rounded-3xl custom-shadow w-full">
                <h2 class="text-3xl font-bold text-center mb-6">Settings</h2>
                <div class="space-y-6">
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                        <label class="font-medium text-lg">Dark Mode</label>
                        <button id="dark-mode-toggle" class="bg-gray-300 w-16 h-8 rounded-full p-1 flex items-center transition-colors duration-300">
                            <div class="bg-white w-6 h-6 rounded-full shadow-md transform transition-transform duration-300"></div>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="admin-page" class="page-content hidden w-full max-w-4xl">
            <div class="container-bg p-8 md:p-12 rounded-3xl custom-shadow w-full">
                <h2 class="text-3xl font-bold text-center mb-6 text-red-600"><i class="fa-solid fa-user-shield"></i> Admin Panel</h2>
                <p class="text-center text-red-500 mb-6 font-semibold">Access Granted for Admin ID: uYFcTwxCdIQJNy5irJF8Scb7Xuq2</p>

                <div class="space-y-8">
                    <div class="border border-red-300 p-6 rounded-xl bg-red-50">
                        <h3 class="text-2xl font-bold text-red-700 mb-4">Global Site Settings</h3>
                        <div class="flex items-center justify-between p-3 bg-white rounded-lg mb-3">
                            <label class="font-medium">Maintenance Mode (Lock entire site)</label>
                            <button id="maintenance-toggle" class="bg-gray-300 w-16 h-8 rounded-full p-1 flex items-center transition-colors duration-300">
                                <div class="bg-white w-6 h-6 rounded-full shadow-md transform transition-transform duration-300"></div>
                            </button>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-white rounded-lg">
                            <label class="font-medium">Global Warning (Yellow Bar at Top)</label>
                            <button id="warning-toggle" class="bg-gray-300 w-16 h-8 rounded-full p-1 flex items-center transition-colors duration-300">
                                <div class="bg-white w-6 h-6 rounded-full shadow-md transform transition-transform duration-300"></div>
                            </button>
                        </div>
                        <textarea id="warning-input" class="mt-4 block w-full p-3 border border-gray-300 rounded-lg" placeholder="Warning text to display globally..."></textarea>
                        <button id="save-global-settings-btn" class="mt-3 w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-4 rounded-xl">Save Global Settings</button>
                    </div>

                    <div class="border border-red-300 p-6 rounded-xl bg-red-50">
                        <h3 class="text-2xl font-bold text-red-700 mb-4">Chat Admin Management</h3>
                        <p class="text-sm text-gray-700 mb-3">Manually ban users from Chat Admin.</p>
                        <div class="flex gap-2">
                            <input type="text" id="ban-user-id-input" placeholder="User ID to ban (e.g., K9j2...)" class="flex-grow p-3 border border-gray-300 rounded-lg">
                            <button id="ban-user-btn" class="bg-red-500 hover:bg-red-600 text-white py-3 px-4 rounded-xl">Ban Chat User</button>
                        </div>
                        <h4 class="font-bold mt-4">Banned Chat Users:</h4>
                        <ul id="banned-user-list" class="space-y-1 mt-2 text-sm"></ul>
                    </div>
                    
                    <div class="border border-blue-300 p-6 rounded-xl bg-blue-50">
                        <h3 class="text-2xl font-bold text-blue-700 mb-4">All Link Management (<span id="total-links-count">0</span> Total)</h3>
                        <div class="flex justify-end mb-4">
                            <button id="open-add-link-modal-btn" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-xl"><i class="fa-solid fa-plus"></i> Add New Link</button>
                        </div>
                        <div id="all-links-list" class="space-y-4">
                            </div>
                        <div id="admin-link-loading" class="text-center text-gray-500 mt-4">Loading all links...</div>
                    </div>
                </div>
            </div>
        </div>


        <div id="edit-modal" class="hidden fixed inset-0 flex items-center justify-center text-center bg-gray-900 bg-opacity-90 z-[101] p-4">
            <div class="container-bg p-8 md:p-12 rounded-3xl custom-shadow w-full max-w-lg">
                <h2 class="text-2xl font-bold mb-4">Edit Link</h2>
                <p id="edit-modal-owner" class="text-sm text-gray-500 mb-4"></p>
                <input type="hidden" id="edit-doc-id">
                <div class="space-y-4">
                    <div>
                        <label for="edit-long-url" class="block text-sm font-medium text-gray-700 text-left">Original URL</label>
                        <input type="url" id="edit-long-url" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="edit-custom-domain" class="block text-sm font-medium text-gray-700 text-left">Custom Domain</label>
                        <input type="text" id="edit-custom-domain" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="edit-expiry-date" class="block text-sm font-medium text-gray-700 text-left">Expiry Date</label>
                        <input type="date" id="edit-expiry-date" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button id="cancel-edit-button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-6 rounded-xl transition-colors duration-200">
                        Cancel
                    </button>
                    <button id="save-edit-button" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-xl transition-colors duration-200">
                        Save
                    </button>
                </div>
            </div>
        </div>

        <div id="add-link-modal" class="hidden fixed inset-0 flex items-center justify-center text-center bg-gray-900 bg-opacity-90 z-[101] p-4">
            <div class="container-bg p-8 md:p-12 rounded-3xl custom-shadow w-full max-w-lg">
                <h2 class="text-2xl font-bold mb-4">Add New Link (Admin)</h2>
                <div class="space-y-4">
                    <div>
                        <label for="add-long-url" class="block text-sm font-medium text-gray-700 text-left">Original URL</label>
                        <input type="url" id="add-long-url" placeholder="https://..." class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="add-custom-domain" class="block text-sm font-medium text-gray-700 text-left">Custom Domain</label>
                        <input type="text" id="add-custom-domain" placeholder="custom-slug" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="flex items-center justify-between">
                        <label for="add-is-iframe" class="block text-sm font-medium text-gray-700 text-left">Iframe Shorten?</label>
                        <input type="checkbox" id="add-is-iframe" class="w-5 h-5">
                    </div>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button id="cancel-add-link-button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-6 rounded-xl transition-colors duration-200">
                        Cancel
                    </button>
                    <button id="save-add-link-button" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-xl transition-colors duration-200">
                        Create Link
                    </button>
                </div>
            </div>
        </div>


        <div id="redirect-ui" class="hidden fixed inset-0 flex flex-col items-center justify-center text-center bg-gray-900 bg-opacity-90 z-[100] p-4">
            <div class="container-bg p-8 md:p-12 rounded-3xl custom-shadow w-full max-w-2xl">
                <h1 class="text-4xl font-bold mb-4 text-blue-600" id="redirect-title">Link Ready</h1>
                <p class="text-lg text-gray-600 mb-4" id="redirect-message">Mohon tunggu 15 detik untuk verifikasi anti-bot.</p>
                
                <div id="activity-detector" class="my-6">
                    <div id="activity-progress">
                        <span id="activity-text">Mohon Gerakkan Mouse/Sentuh Layar</span>
                    </div>
                </div>

                <div id="redirect-countdown-container" class="hidden">
                    <div id="redirect-countdown" class="text-6xl font-bold text-blue-600 my-4">15</div>
                </div>
                
                <button id="go-link-button" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-4 px-8 rounded-xl transition-colors duration-300 hidden mt-4">
                    Continue to Link
                </button>
            </div>
        </div>
        <div id="warning-ui" class="hidden fixed inset-0 flex items-center justify-center text-center bg-gray-900 bg-opacity-90 z-[100] p-4">
            <div class="bg-red-800 p-8 md:p-12 rounded-3xl custom-shadow w-full max-w-2xl text-white">
                <h1 class="text-4xl font-bold mb-4">This Website May Be Dangerous</h1>
                <p class="text-lg text-red-200 mb-4">This site has been flagged as potentially dangerous by our security database.</p>
                <div class="flex flex-col sm:flex-row justify-center gap-4 mt-4">
                    <button id="go-back-button" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-6 rounded-xl transition-colors duration-300">
                        Go Back
                    </button>
                    <button id="proceed-button" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-6 rounded-xl transition-colors duration-300">
                        Proceed
                    </button>
                </div>
            </div>
        </div>

        <div id="iframe-wrapper" class="hidden"></div>
        
        <div id="iframe-footbar" class="hidden flex items-center justify-between px-4 py-2 h-[60px]">
            <div class="flex items-center gap-2">
                <span class="text-sm sm:text-lg">URL by </span>
                <img src="https://iili.io/KFlsOAX.png" alt="ShareU Logo" class="h-6">
                <span class="text-lg font-bold text-blue-400">ShareU</span>
            </div>
            <a href="/" id="footbar-shorten-link" class="flex items-center bg-blue-600 hover:bg-blue-700 text-white font-semibold py-1 px-3 rounded-xl transition-colors duration-200 text-sm">
                Start Shortening Your URL
            </a>
        </div>

        <div id="message-box" class="fixed bottom-4 left-1/2 -translate-x-1/2 bg-gray-800 text-white p-4 rounded-lg shadow-lg z-[101] transform translate-y-full opacity-0 transition-all duration-500 ease-in-out">
            <p id="message-text"></p>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, where, onSnapshot, runTransaction, addDoc, deleteDoc, updateDoc, getDocs, orderBy, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        setLogLevel('debug');

        // --- CONSTANTS ---
        const ADMIN_UID = 'uYFcTwxCdIQJNy5irJF8Scb7Xuq2';
        const TOXIC_WORDS = ['fuck', 'shit', 'asshole', 'bitch', 'kontol', 'memek', 'anjing', 'babi', 'tolol', 'goblok', 'jancuk'];
        const CHAT_COOLDOWN_SECONDS = 5;
        const ANTI_BOT_DURATION = 15; // Waktu verifikasi anti-bot (detik)

        // --- Firebase Configuration & Initialization ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyAlGXpZSyQab7riDteV5ppS3DXDJQHywKw",
            authDomain: "modmanagerpro-248f5.firebaseapp.com",
            projectId: "modmanagerpro-248f5",
            storageBucket: "modmanagerpro-248f5.appspot.com",
            messagingSenderId: "594650288669",
            appId: "1:594650288669:web:3308b084911e2ef7f1ecf4",
            measurementId: "G-TE9234E3LP"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let userId = null;
        let isIframeShorten = false;
        let isMaintenanceMode = false;
        let isChatBanned = false;
        let lastChatMessageTime = 0;
        let currentPage = 'shortener'; // Default page
        
        // --- Anti-Bot State (New) ---
        let isActivityDetected = false;
        let activityInterval = null;
        let activityTimer = 0;
        let antiBotPass = false;


        // --- UI Elements ---
        const navButtons = document.querySelectorAll('.nav-btn');
        const pages = document.querySelectorAll('.page-content');
        const loadingSpinner = document.getElementById('loading-spinner');
        const shortenButton = document.getElementById('shorten-button');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const redirectUI = document.getElementById('redirect-ui');
        const warningUI = document.getElementById('warning-ui');
        const userIdSpan = document.getElementById('user-id-span');
        const shortenTypeSlider = document.getElementById('shorten-type-slider');
        const sliderThumb = shortenTypeSlider.querySelector('.slider-thumb');
        const iframeFootbar = document.getElementById('iframe-footbar');
        const iframeWrapper = document.getElementById('iframe-wrapper');
        const editModal = document.getElementById('edit-modal');
        const saveEditButton = document.getElementById('save-edit-button');
        const cancelEditButton = document.getElementById('cancel-edit-button');
        const shortUrlOutput = document.getElementById('short-url-output');
        const qrcodeContainer = document.getElementById('qrcode-container');
        const copyButton = document.getElementById('copy-button');
        const downloadQrButton = document.getElementById('download-qr-button');
        // Drag UI elements removed
        const goLinkButton = document.getElementById('go-link-button');
        const redirectCountdown = document.getElementById('redirect-countdown');
        const redirectCountdownContainer = document.getElementById('redirect-countdown-container');
        
        // New Anti-Bot UI Elements
        const activityDetector = document.getElementById('activity-detector');
        const activityProgress = document.getElementById('activity-progress');
        const activityText = document.getElementById('activity-text');
        
        // Admin UI Elements (rest)
        const adminNavBtn = document.getElementById('admin-nav-btn');
        const globalWarningUI = document.getElementById('global-warning-ui');
        const globalWarningText = document.getElementById('global-warning-text');
        const maintenanceUI = document.getElementById('maintenance-ui');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const maintenanceToggle = document.getElementById('maintenance-toggle');
        const warningToggle = document.getElementById('warning-toggle');
        const warningInput = document.getElementById('warning-input');
        const saveGlobalSettingsBtn = document.getElementById('save-global-settings-btn');
        const chatWindow = document.getElementById('chat-window');
        const chatInput = document.getElementById('chat-input');
        const sendChatButton = document.getElementById('send-chat-button');
        const chatStatus = document.getElementById('chat-status');
        const banUserIdInput = document.getElementById('ban-user-id-input');
        const banUserBtn = document.getElementById('ban-user-btn');
        const bannedUserList = document.getElementById('banned-user-list');
        const allLinksList = document.getElementById('all-links-list');
        const totalLinksCount = document.getElementById('total-links-count');
        const adminLinkLoading = document.getElementById('admin-link-loading');
        const addLinkModal = document.getElementById('add-link-modal');
        const openAddLinkModalBtn = document.getElementById('open-add-link-modal-btn');
        const saveAddLinkButton = document.getElementById('save-add-link-button');
        const cancelAddLinkButton = document.getElementById('cancel-add-link-button');


        // --- Utility Functions ---
        const showMessage = (text) => {
            messageText.textContent = text;
            messageBox.classList.remove('translate-y-full', 'opacity-0');
            messageBox.classList.add('translate-y-0', 'opacity-100');
            setTimeout(() => {
                messageBox.classList.remove('translate-y-0', 'opacity-100');
                messageBox.classList.add('translate-y-full', 'opacity-0');
            }, 3000);
        };

        const showPage = (pageName) => {
            if (isMaintenanceMode && pageName !== 'admin' && !isAdmin()) {
                 // Block non-admin from navigating away from maintenance page
                maintenanceUI.classList.remove('hidden');
                return;
            }
            maintenanceUI.classList.add('hidden'); // Hide if not in maintenance mode
            pages.forEach(page => page.classList.add('hidden'));
            const targetPage = document.getElementById(`${pageName}-page`);
            if (targetPage) {
                 targetPage.classList.remove('hidden');
                 currentPage = pageName;
            } else {
                // Fallback to shortener if the page doesn't exist
                document.getElementById('shortener-page').classList.remove('hidden');
                currentPage = 'shortener';
            }

            // Update nav button active state
            navButtons.forEach(btn => {
                if (btn.dataset.page === pageName) {
                    btn.classList.add('bg-white', 'text-blue-600');
                    btn.classList.remove('hover:bg-white', 'hover:text-blue-600');
                } else {
                    btn.classList.remove('bg-white', 'text-blue-600');
                    btn.classList.add('hover:bg-white', 'hover:text-blue-600');
                }
            });
            // Special case for admin button
            if (pageName === 'admin' && isAdmin()) {
                adminNavBtn.classList.add('bg-red-700');
            } else {
                 adminNavBtn.classList.remove('bg-red-700');
            }
        };

        const normalizeSlug = (input) => {
            return input.replace(/[^a-zA-Z0-9-]/g, '').replace(/ +/g, '-').toLowerCase();
        };

        const isAdmin = () => userId === ADMIN_UID;
        const getShortenedUrl = (shortCode) => `${window.location.origin}/${shortCode}`;

        const isToxic = (text) => {
            const lowerText = text.toLowerCase();
            return TOXIC_WORDS.some(word => lowerText.includes(word));
        };

        // --- Dark Mode Logic ---
        const toggleDarkMode = (isDark) => {
            if (isDark) {
                document.body.classList.add('dark-mode');
                localStorage.setItem('theme', 'dark');
            } else {
                document.body.classList.remove('dark-mode');
                localStorage.setItem('theme', 'light');
            }
            updateDarkModeToggleUI(isDark);
        };

        const updateDarkModeToggleUI = (isDark) => {
            const thumb = darkModeToggle.querySelector('div');
            if (isDark) {
                darkModeToggle.classList.remove('bg-gray-300');
                darkModeToggle.classList.add('bg-blue-600');
                thumb.style.transform = 'translateX(100%)';
            } else {
                darkModeToggle.classList.remove('bg-blue-600');
                darkModeToggle.classList.add('bg-gray-300');
                thumb.style.transform = 'translateX(0)';
            }
        };

        // --- Global Settings Logic ---
        const setupGlobalSettingsListener = () => {
            const docRef = doc(db, `artifacts/${appId}/public/data/global_settings`, 'status');

            onSnapshot(docRef, (docSnap) => {
                const settings = docSnap.exists() ? docSnap.data() : { maintenanceMode: false, globalWarning: '', bannedChatUsers: [] };
                
                // 1. Handle Maintenance Mode
                isMaintenanceMode = settings.maintenanceMode || false;
                if (isMaintenanceMode && !isAdmin()) {
                    maintenanceUI.classList.remove('hidden');
                    // Ensure non-admin users cannot navigate away
                    showPage('maintenance');
                } else if (!isMaintenanceMode) {
                    maintenanceUI.classList.add('hidden');
                    // If maintenance ends, ensure current page is accessible
                    showPage(currentPage);
                }
                
                // 2. Handle Global Warning
                if (settings.globalWarning) {
                    globalWarningText.textContent = settings.globalWarning;
                    globalWarningUI.classList.remove('hidden');
                } else {
                    globalWarningUI.classList.add('hidden');
                }

                // 3. Handle Chat Ban Status
                // Only check ban status if userId is available
                if (userId) {
                    isChatBanned = settings.bannedChatUsers && settings.bannedChatUsers.includes(userId);
                    if (isChatBanned) {
                        chatStatus.classList.remove('hidden');
                        chatInput.disabled = true;
                        sendChatButton.disabled = true;
                        chatInput.placeholder = "You are banned from Chat Admin.";
                    } else {
                        chatStatus.classList.add('hidden');
                        chatInput.disabled = false;
                        sendChatButton.disabled = false;
                        chatInput.placeholder = "Type your message...";
                    }
                }

                // 4. Update Admin UI (if Admin is viewing)
                if (isAdmin()) {
                    updateAdminSettingsUI(settings);
                }
            }, (error) => {
                console.error("Error fetching global settings:", error);
            });
        };

        const updateAdminSettingsUI = (settings) => {
             // Maintenance Toggle
            const isMaint = settings.maintenanceMode || false;
            const maintThumb = maintenanceToggle.querySelector('div');
            maintenanceToggle.classList.toggle('bg-green-600', isMaint);
            maintenanceToggle.classList.toggle('bg-gray-300', !isMaint);
            maintThumb.style.transform = isMaint ? 'translateX(100%)' : 'translateX(0)';
            
            // Warning Toggle
            const hasWarning = !!settings.globalWarning;
            const warnThumb = warningToggle.querySelector('div');
            warningToggle.classList.toggle('bg-green-600', hasWarning);
            warningToggle.classList.toggle('bg-gray-300', !hasWarning);
            warnThumb.style.transform = hasWarning ? 'translateX(100%)' : 'translateX(0)';

            // Warning Text Input
            warningInput.value = settings.globalWarning || '';

            // Banned Users List
            bannedUserList.innerHTML = '';
            if (settings.bannedChatUsers && settings.bannedChatUsers.length > 0) {
                settings.bannedChatUsers.forEach(bannedId => {
                    const listItem = document.createElement('li');
                    listItem.className = 'flex items-center justify-between p-2 bg-gray-100 rounded-lg';
                    listItem.innerHTML = `
                        <span class="font-mono text-xs">${bannedId}</span>
                        <button class="unban-btn text-xs text-red-500 hover:text-red-700" data-id="${bannedId}">Unban</button>
                    `;
                    bannedUserList.appendChild(listItem);
                });
            } else {
                bannedUserList.innerHTML = '<li class="text-gray-500 text-sm">No users are currently banned.</li>';
            }
        };


        // --- Firebase Configuration and Initialization ---
        const initializeFirebase = async () => {
            // Hide everything initially
            document.body.querySelectorAll('.page-content').forEach(el => el.classList.add('hidden'));
            loadingSpinner.classList.remove('hidden');
            
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                userId = auth.currentUser.uid;
                userIdSpan.textContent = userId;
                
                // Dark Mode setup
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme === 'dark') {
                    toggleDarkMode(true);
                } else {
                    toggleDarkMode(false);
                }

                setupGlobalSettingsListener();
                
                // Show Admin button if admin
                if (isAdmin()) {
                    adminNavBtn.classList.remove('hidden');
                    setupAdminLinkManagement();
                }
                
                // --- PENTING: Pengecekan URL untuk Redirect ---
                const isRedirecting = await handleUrlPath(); 
                
                if (!isRedirecting) {
                    // Jika handleUrlPath tidak mengalihkan (misal: ada di root path), inisialisasi listener lainnya
                    setupRealtimeHistory();
                    setupForumListener();
                    setupChatAdminListener();
                
                    // Initial page load
                    if (window.location.pathname === '/' || window.location.pathname.startsWith('/index.html')) {
                        showPage('shortener');
                    }
                }
                
                loadingSpinner.classList.add('hidden');

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showMessage("Failed to connect to Firebase. Please try again later.");
                loadingSpinner.classList.add('hidden');
            }
        };

        // --- Redirect/URL Path Handler (PENTING!) ---
        const handleUrlPath = async () => {
            const path = window.location.pathname.substring(1);
            if (!path || path.startsWith('index.html')) {
                // We are at the root or main file, show main content
                return false; // Not redirecting
            }

            const docRef = doc(db, `artifacts/${appId}/public/data/short_urls`, path);
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // 1. Check Expiry
                    if (data.expiryDate && new Date(data.expiryDate) < new Date()) {
                        document.getElementById('redirect-title').textContent = 'Link Expired';
                        document.getElementById('redirect-message').textContent = 'This shortened link has expired.';
                        activityDetector.classList.add('hidden');
                        goLinkButton.classList.remove('hidden');
                        goLinkButton.textContent = 'Go Home';
                        goLinkButton.onclick = () => window.location.href = window.location.origin;
                        redirectUI.classList.remove('hidden');
                        loadingSpinner.classList.add('hidden');
                        return true;
                    }

                    // 2. Start Redirect Flow (with Anti-Bot)
                    startRedirectFlow(data);
                    return true; // Is redirecting
                    
                } else {
                    // Link not found, redirect to home with error
                    showMessage(`Short link /${path} not found.`);
                    window.location.replace(window.location.origin);
                    return true; // Redirecting away from this page
                }
            } catch (error) {
                console.error("Error handling redirect:", error);
                showMessage("Error during redirection process.");
                window.location.replace(window.location.origin);
                return true; // Redirecting away from this page
            }
        };

        // --- Anti-Bot & Redirect Flow (Updated) ---
        const startRedirectFlow = (data) => {
            document.body.classList.add('iframe-active');
            redirectUI.classList.remove('hidden');
            loadingSpinner.classList.add('hidden');
            activityDetector.classList.remove('hidden');
            goLinkButton.classList.add('hidden');
            antiBotPass = false;
            isActivityDetected = false;
            activityTimer = 0;
            activityProgress.style.width = '0%';
            activityText.textContent = 'Mohon Gerakkan Mouse/Sentuh Layar';
            
            // Listeners untuk deteksi aktivitas
            document.addEventListener('mousemove', handleActivity);
            document.addEventListener('touchstart', handleActivity);
            document.addEventListener('scroll', handleActivity);

            // Start activity check and timer
            activityInterval = setInterval(() => {
                if (isActivityDetected) {
                    activityTimer++;
                    const progress = (activityTimer / ANTI_BOT_DURATION) * 100;
                    activityProgress.style.width = `${progress}%`;
                    activityText.textContent = `Aktivitas Terdeteksi. Menunggu ${ANTI_BOT_DURATION - activityTimer} detik...`;

                    if (activityTimer >= ANTI_BOT_DURATION) {
                        clearInterval(activityInterval);
                        document.removeEventListener('mousemove', handleActivity);
                        document.removeEventListener('touchstart', handleActivity);
                        document.removeEventListener('scroll', handleActivity);
                        
                        antiBotPass = true;
                        activityProgress.style.width = '100%';
                        activityText.textContent = 'Verifikasi Berhasil!';
                        
                        // Start countdown to Final Redirect
                        startCountdown(data);
                    }
                    isActivityDetected = false; // Reset flag for next interval
                } else {
                    activityText.textContent = 'Aktivitas Tidak Terdeteksi. Gerakkan Mouse!';
                }
            }, 1000);
        };

        const handleActivity = () => {
             // Set flag to true if any mouse movement, touch, or scroll event is detected
            isActivityDetected = true;
        };

        const startCountdown = async (data) => {
            // PENTING: Increment Clicks DILAKUKAN DI SINI, setelah verifikasi anti-bot berhasil.
            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/short_urls`, data.shortCode);
                await updateDoc(docRef, { clicks: increment(1) });
                console.log("Clicks incremented successfully after anti-bot verification.");
            } catch (e) {
                console.error("Failed to increment clicks:", e);
                // Lanjutkan ke redirect meskipun gagal update klik, agar pengunjung tidak terhambat.
            }

            activityDetector.classList.add('hidden');
            redirectCountdownContainer.classList.remove('hidden');
            document.getElementById('redirect-title').textContent = 'Lanjut ke Link';
            document.getElementById('redirect-message').textContent = 'Verifikasi berhasil. Klik tombol untuk melanjutkan.';

            let count = 3; // Ubah hitungan mundur menjadi singkat setelah verifikasi anti-bot
            redirectCountdown.textContent = count;
            
            const interval = setInterval(() => {
                count--;
                redirectCountdown.textContent = count;

                if (count <= 0) {
                    clearInterval(interval);
                    redirectCountdownContainer.classList.add('hidden');
                    goLinkButton.classList.remove('hidden');
                    
                    goLinkButton.onclick = () => {
                        handleFinalRedirect(data);
                    };
                    // Auto-click for better UX
                    goLinkButton.click(); 
                }
            }, 1000);
        };

        const handleFinalRedirect = (data) => {
            const targetUrl = data.longUrl;
            
            if (data.isIframe) {
                // Iframe Mode
                redirectUI.classList.add('hidden');
                iframeWrapper.classList.remove('hidden');
                iframeFootbar.classList.remove('hidden');
                
                const iframe = document.createElement('iframe');
                iframe.src = targetUrl;
                iframeWrapper.innerHTML = '';
                iframeWrapper.appendChild(iframe);
            } else {
                // Basic Redirect Mode
                window.location.replace(targetUrl);
            }
        };


        // --- Link Shortening Logic ---
        shortenButton.addEventListener('click', async () => {
            if (isMaintenanceMode && !isAdmin()) {
                showMessage("Link shortening is disabled due to site maintenance.");
                return;
            }
            
            const longUrl = document.getElementById('long-url-input').value.trim();
            const customSlug = normalizeSlug(document.getElementById('custom-domain-input').value.trim());
            const expiryDate = document.getElementById('expiry-date-input').value;

            if (!longUrl) {
                showMessage("Please enter a valid URL.");
                return;
            }

            const urlWithProtocol = longUrl.startsWith('http://') || longUrl.startsWith('https://') ? longUrl : `https://${longUrl}`;
            const shortCode = customSlug || Math.random().toString(36).substring(2, 8);

            try {
                const linksCollection = collection(db, `artifacts/${appId}/public/data/short_urls`);
                const docRef = doc(linksCollection, shortCode);

                await runTransaction(db, async (transaction) => {
                    const docSnap = await transaction.get(docRef);
                    if (docSnap.exists()) {
                        throw new Error("This custom domain is already in use.");
                    }

                    const linkData = {
                        longUrl: urlWithProtocol,
                        shortCode: shortCode,
                        createdBy: userId,
                        createdAt: new Date(),
                        clicks: 0,
                        isIframe: isIframeShorten,
                        expiryDate: expiryDate || null,
                    };

                    transaction.set(docRef, linkData);
                });

                const shortUrl = getShortenedUrl(shortCode);
                shortUrlOutput.textContent = shortUrl;
                document.getElementById('result-container').classList.remove('hidden');
                showMessage("Link successfully shortened!");
                
                // Generate QR Code
                qrcodeContainer.innerHTML = '';
                new QRCode(qrcodeContainer, {
                    text: shortUrl,
                    width: 128,
                    height: 128,
                    colorDark: document.body.classList.contains('dark-mode') ? "#e0e0e0" : "#000000",
                    colorLight: document.body.classList.contains('dark-mode') ? "#1f1f1f" : "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });

            } catch (e) {
                console.error("Transaction failed:", e);
                if (e.message.includes("custom domain")) {
                    showMessage(e.message);
                } else {
                    showMessage("Failed to shorten link. Please try again.");
                }
            }
        });

        // --- History / Realtime Data Listeners (Perbaikan: Null/Undefined Check) ---

        const setupRealtimeHistory = () => {
            const linksCollection = collection(db, `artifacts/${appId}/public/data/short_urls`);
            const q = query(linksCollection, where('createdBy', '==', userId));
            
            const historyList = document.getElementById('history-list');
            const loadingHistory = document.getElementById('loading-history');
            
            onSnapshot(q, (snapshot) => {
                loadingHistory.classList.add('hidden');
                historyList.innerHTML = '';
                
                if (snapshot.empty) {
                    historyList.innerHTML = '<p class="text-center text-gray-500">You have no links created yet.</p>';
                    return;
                }

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const docId = doc.id;
                    const listItem = document.createElement('div');
                    listItem.className = "bg-white p-4 rounded-xl flex items-center justify-between border border-gray-100";
                    
                    // --- PERBAIKAN PENTING: Null/Undefined Check pada longUrl ---
                    const originalLongUrl = data.longUrl || 'URL tidak tersedia';
                    const longUrl = originalLongUrl.length > 40 ? `${originalLongUrl.substring(0, 40)}...` : originalLongUrl;
                    // --- END PERBAIKAN ---

                    const fullShortUrl = getShortenedUrl(data.shortCode);
                    const expiryText = data.expiryDate ? ` | Expires: ${data.expiryDate}` : '';
                    const typeLabel = data.isIframe ? 'IFRAME' : 'BASIC';
                    
                    listItem.innerHTML = `
                        <div class="flex-grow">
                            <a href="${fullShortUrl}" target="_blank" class="text-blue-600 hover:underline font-semibold text-lg">${data.shortCode} <i class="fa-solid fa-arrow-up-right-from-square text-sm ml-1"></i></a>
                            <p class="text-sm text-gray-700 break-all">${longUrl}</p>
                            <p class="text-xs text-gray-500 mt-1">Clicks: ${data.clicks || 0} | Type: ${typeLabel}${expiryText}</p>
                        </div>
                        <div class="flex gap-2">
                            <button class="edit-btn bg-yellow-500 hover:bg-yellow-600 text-white text-xs px-3 py-1 rounded-lg" data-id="${docId}">Edit</button>
                            <button class="delete-btn bg-red-500 hover:bg-red-600 text-white text-xs px-3 py-1 rounded-lg" data-id="${docId}">Delete</button>
                        </div>
                    `;
                    historyList.appendChild(listItem);
                });
            });
        };

        const setupForumListener = () => {
            const forumCollection = collection(db, `artifacts/${appId}/public/data/forum_posts`);
            const q = query(forumCollection, orderBy('createdAt', 'desc'));
            
            onSnapshot(q, (snapshot) => {
                const postsContainer = document.getElementById('forum-posts');
                postsContainer.innerHTML = '';
                
                if (snapshot.empty) {
                    postsContainer.innerHTML = '<p class="text-center text-gray-500">No forum posts yet. Be the first!</p>';
                    return;
                }

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const postElement = document.createElement('div');
                    postElement.className = "bg-gray-50 p-4 rounded-xl border border-gray-200";
                    
                    // --- PERBAIKAN: Cek apakah perlu toDate() sebelum memanggil toLocaleString() ---
                    const time = data.createdAt 
                        ? (typeof data.createdAt.toDate === 'function' 
                            ? data.createdAt.toDate().toLocaleString() 
                            : data.createdAt.toLocaleString()) 
                        : 'Just now';
                    
                    // --- PERBAIKAN: Null/Undefined Check pada data.createdBy ---
                    const userDisplay = data.createdBy 
                        ? (data.createdBy === userId ? 'You' : data.createdBy.substring(0, 5)) 
                        : 'Anonim';
                    
                    postElement.innerHTML = `
                        <p class="font-medium text-gray-800">${data.content}</p>
                        <p class="text-xs text-gray-500 mt-2">Posted by <span class="font-semibold">${userDisplay}</span> on ${time}</p>
                    `;
                    postsContainer.appendChild(postElement);
                });
            });
        };

        // --- Forum Post Handler ---
        document.getElementById('post-button').addEventListener('click', async () => {
            if (isMaintenanceMode && !isAdmin()) {
                showMessage("Forum posting is disabled due to site maintenance.");
                return;
            }

            const content = document.getElementById('forum-input').value.trim();
            if (!content) {
                showMessage("Please write something to post.");
                return;
            }

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/forum_posts`), {
                    content: content,
                    createdBy: userId,
                    createdAt: new Date(),
                });
                document.getElementById('forum-input').value = '';
                showMessage("Post successfully created!");
            } catch (e) {
                console.error("Error adding forum post:", e);
                showMessage("Failed to create post. Please try again.");
            }
        });

        // --- Admin Link Management ---

        const setupAdminLinkManagement = () => {
            if (!isAdmin()) return;

            const linksCollection = collection(db, `artifacts/${appId}/public/data/short_urls`);
            const q = query(linksCollection);
            
            adminLinkLoading.classList.remove('hidden');

            onSnapshot(q, (snapshot) => {
                allLinksList.innerHTML = '';
                adminLinkLoading.classList.add('hidden');
                totalLinksCount.textContent = snapshot.size;
                
                if (snapshot.empty) {
                    allLinksList.innerHTML = '<p class="text-center text-gray-500">No links have been created across the platform.</p>';
                    return;
                }

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const docId = doc.id;
                    const listItem = document.createElement('div');
                    listItem.className = "bg-white p-4 rounded-xl flex items-center justify-between border border-gray-100";
                    
                    const longUrlDisplay = data.longUrl ? (data.longUrl.length > 40 ? `${data.longUrl.substring(0, 40)}...` : data.longUrl) : 'URL tidak tersedia';
                    const fullShortUrl = getShortenedUrl(data.shortCode);
                    const owner = data.createdBy === ADMIN_UID ? 'ADMIN' : (data.createdBy ? data.createdBy.substring(0, 5) : 'Anonim');
                    const typeLabel = data.isIframe ? 'IFRAME' : 'BASIC';
                    
                    listItem.innerHTML = `
                        <div class="flex-grow">
                            <p class="text-xs text-gray-500">Owner: <span class="font-mono text-blue-600">${owner}</span> | Type: ${typeLabel}</p>
                            <a href="${data.longUrl}" target="_blank" class="text-sm font-medium hover:underline break-all">${longUrlDisplay}</a>
                            <p class="text-sm font-mono mt-1"><a href="${fullShortUrl}" target="_blank">${data.shortCode}</a></p>
                            <p class="text-xs text-gray-500">Clicks: ${data.clicks || 0}</p>
                        </div>
                        <div class="flex gap-2">
                            <button class="edit-btn bg-yellow-500 hover:bg-yellow-600 text-white text-xs px-3 py-1 rounded-lg" data-id="${docId}" data-owner="${data.createdBy}">Edit</button>
                            <button class="delete-btn bg-red-500 hover:bg-red-600 text-white text-xs px-3 py-1 rounded-lg" data-id="${docId}">Delete</button>
                        </div>
                    `;
                    allLinksList.appendChild(listItem);
                });
            }, (error) => {
                console.error("Error fetching all links: ", error);
                showMessage("Failed to load all links.");
            });
        };

        // --- Chat Admin Logic ---

        const setupChatAdminListener = () => {
            if (!db) return;
            const chatCollection = collection(db, `artifacts/${appId}/public/data/chat_admin`);
            const q = query(chatCollection, orderBy('createdAt'));
            
            onSnapshot(q, (snapshot) => {
                chatWindow.innerHTML = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const isSender = data.userId === userId;
                    const isSystemAdmin = data.userId === ADMIN_UID;
                    const alignmentClass = isSender ? 'self-end' : 'self-start';
                    const colorClass = isSender ? 'bg-blue-600 text-white' : (isSystemAdmin ? 'bg-red-200 text-gray-800' : 'bg-gray-200 text-gray-800');
                    const senderLabel = isSender ? 'You' : (isSystemAdmin ? 'Admin' : (data.truncatedUserId || 'Anonim'));

                    const messageElement = document.createElement('div');
                    messageElement.className = `max-w-[70%] ${alignmentClass} p-3 rounded-xl shadow-md ${colorClass} w-fit`;
                    messageElement.style.marginLeft = isSender ? 'auto' : 'unset';
                    messageElement.style.marginRight = isSender ? 'unset' : 'auto';
                    
                    // --- PERBAIKAN: Cek apakah perlu toDate() sebelum memanggil toLocaleTimeString() ---
                    const chatTime = data.createdAt 
                        ? (typeof data.createdAt.toDate === 'function' 
                            ? data.createdAt.toDate().toLocaleTimeString() 
                            : (data.createdAt.toLocaleTimeString ? data.createdAt.toLocaleTimeString() : 'Unknown Time')) // Fallback for Date object
                        : 'Unknown Time';

                    messageElement.innerHTML = `
                        <p class="text-xs font-semibold mb-1 ${isSender ? 'text-blue-100' : (isSystemAdmin ? 'text-red-600' : 'text-blue-500')}">${senderLabel}</p>
                        <p>${data.content}</p>
                        <p class="text-[10px] text-right mt-1 ${isSender ? 'text-blue-200' : 'text-gray-500'}">${chatTime}</p>
                    `;
                    chatWindow.appendChild(messageElement);
                });
                chatWindow.scrollTop = chatWindow.scrollHeight; // Auto scroll to bottom
            }, (error) => {
                console.error("Error fetching chat messages:", error);
            });
        };

        sendChatButton.addEventListener('click', async () => {
            const content = chatInput.value.trim();
            const now = Date.now();

            if (isChatBanned) {
                showMessage("You are permanently banned from Chat Admin.");
                return;
            }

            if (isMaintenanceMode && !isAdmin()) {
                showMessage("Chat Admin is disabled due to site maintenance.");
                return;
            }

            if (!content) return;

            if (now - lastChatMessageTime < CHAT_COOLDOWN_SECONDS * 1000) {
                const remaining = Math.ceil(CHAT_COOLDOWN_SECONDS - (now - lastChatMessageTime) / 1000);
                showMessage(`Please wait ${remaining} seconds before sending another message.`);
                return;
            }

            if (isToxic(content)) {
                await banUserFromChat(userId, true, "Violating toxicity policy.");
                showMessage("Toxicity detected. You have been permanently banned from Chat Admin.");
                chatInput.value = '';
                return;
            }

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/chat_admin`), {
                    content: content,
                    userId: userId,
                    truncatedUserId: isAdmin() ? 'Admin' : userId.substring(0, 5),
                    createdAt: new Date(),
                });
                chatInput.value = '';
                lastChatMessageTime = now;
            } catch (e) {
                console.error("Error adding chat message:", e);
                showMessage("Failed to send message. Please try again.");
            }
        });

        // --- Admin Specific Event Listeners ---

        // Global Settings Toggles
        maintenanceToggle.addEventListener('click', () => {
            if (!isAdmin()) return;
            const isMaint = maintenanceToggle.classList.contains('bg-green-600');
            // Optimistic UI update for toggle
            const maintThumb = maintenanceToggle.querySelector('div');
            maintenanceToggle.classList.toggle('bg-green-600', !isMaint);
            maintenanceToggle.classList.toggle('bg-gray-300', isMaint);
            maintThumb.style.transform = !isMaint ? 'translateX(100%)' : 'translateX(0)';
        });

        warningToggle.addEventListener('click', () => {
            if (!isAdmin()) return;
            const hasWarning = warningToggle.classList.contains('bg-green-600');
            const newWarningState = !hasWarning;
            
            // Optimistic UI update for toggle
            const warnThumb = warningToggle.querySelector('div');
            warningToggle.classList.toggle('bg-green-600', newWarningState);
            warningToggle.classList.toggle('bg-gray-300', !newWarningState);
            warnThumb.style.transform = newWarningState ? 'translateX(100%)' : 'translateX(0)';

            // Clear input if warning is being turned off
            if (!newWarningState) {
                warningInput.value = '';
            } else if (!warningInput.value) {
                 // Set a default warning if turning on and input is empty
                warningInput.value = 'Important Announcement: Check the latest updates!';
            }
        });

        // Save Global Settings
        saveGlobalSettingsBtn.addEventListener('click', async () => {
            if (!isAdmin()) return;
            const isMaint = maintenanceToggle.classList.contains('bg-green-600');
            const hasWarningActive = warningToggle.classList.contains('bg-green-600');
            let warningText = hasWarningActive ? warningInput.value.trim() : '';

            if (hasWarningActive && !warningText) {
                showMessage("Warning is toggled ON but the text is empty. Please enter a message or toggle OFF.");
                return;
            }

            try {
                const existingSettings = (await getDoc(doc(db, `artifacts/${appId}/public/data/global_settings`, 'status'))).data() || {};
                
                await setDoc(doc(db, `artifacts/${appId}/public/data/global_settings`, 'status'), {
                    maintenanceMode: isMaint,
                    globalWarning: warningText,
                    // Preserve banned users list
                    bannedChatUsers: existingSettings.bannedChatUsers || []
                }, { merge: true });
                showMessage("Global settings successfully updated!");
            } catch (e) {
                console.error("Error saving global settings:", e);
                showMessage("Failed to save global settings.");
            }
        });

        // Ban/Unban User Logic
        const banUserFromChat = async (targetId, banStatus, reason = "") => {
            if (!isAdmin() && banStatus && targetId !== userId) {
                // Only allow self-ban (from toxic filter) if not admin
                return; 
            }
            try {
                const settingsRef = doc(db, `artifacts/${appId}/public/data/global_settings`, 'status');
                await runTransaction(db, async (transaction) => {
                    const settingsDoc = await transaction.get(settingsRef);
                    const bannedList = settingsDoc.data().bannedChatUsers || [];
                    
                    if (banStatus && !bannedList.includes(targetId)) {
                        transaction.update(settingsRef, { bannedChatUsers: [...bannedList, targetId] });
                        showMessage(`User ${targetId} banned from chat. ${reason}`);
                    } else if (!banStatus && bannedList.includes(targetId)) {
                        transaction.update(settingsRef, { bannedChatUsers: bannedList.filter(id => id !== targetId) });
                        showMessage(`User ${targetId} unbanned from chat.`);
                    }
                });
            } catch (e) {
                console.error("Transaction failed (ban/unban):", e);
                showMessage("Failed to update ban status.");
            }
        };

        banUserBtn.addEventListener('click', () => {
            const targetId = banUserIdInput.value.trim();
            if (targetId && isAdmin()) {
                banUserFromChat(targetId, true, "Manually banned by admin.");
                banUserIdInput.value = '';
            }
        });

        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('unban-btn') && isAdmin()) {
                const targetId = e.target.dataset.id;
                banUserFromChat(targetId, false);
            }
        });

        // Admin Add Link Modal
        openAddLinkModalBtn.addEventListener('click', () => {
            if (!isAdmin()) return;
            document.getElementById('add-long-url').value = '';
            document.getElementById('add-custom-domain').value = '';
            document.getElementById('add-is-iframe').checked = false;
            addLinkModal.classList.remove('hidden');
        });
        
        cancelAddLinkButton.addEventListener('click', () => {
            addLinkModal.classList.add('hidden');
        });

        saveAddLinkButton.addEventListener('click', async () => {
            if (!isAdmin()) return;
            const longUrl = document.getElementById('add-long-url').value.trim();
            const customSlug = normalizeSlug(document.getElementById('add-custom-domain').value.trim());
            const isIframe = document.getElementById('add-is-iframe').checked;

            if (!longUrl || !customSlug) {
                showMessage("URL and Custom Domain are required.");
                return;
            }

            try {
                const linksCollection = collection(db, `artifacts/${appId}/public/data/short_urls`);
                const docRef = doc(linksCollection, customSlug);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    showMessage("This custom domain is already in use.");
                    return;
                }
                
                const urlWithProtocol = longUrl.startsWith('http://') || longUrl.startsWith('https://') ? longUrl : `https://${longUrl}`;

                await setDoc(docRef, {
                    longUrl: urlWithProtocol,
                    shortCode: customSlug,
                    createdAt: new Date(),
                    createdBy: ADMIN_UID, // Added by admin
                    clicks: 0,
                    isIframe: isIframe,
                });
                
                addLinkModal.classList.add('hidden');
                showMessage(`Link ${customSlug} successfully created by Admin!`);

            } catch (e) {
                console.error("Error creating admin link: ", e);
                showMessage("Failed to create link.");
            }
        });

        // --- Dark Mode Event Listener ---
        darkModeToggle.addEventListener('click', () => {
            const isDark = !document.body.classList.contains('dark-mode');
            toggleDarkMode(isDark);
        });

        // --- Global Event Listeners (Navigation, Edit, Delete) ---

        // Navigation
        navButtons.forEach(button => {
            button.addEventListener('click', () => {
                showPage(button.dataset.page);
            });
        });

        // Shorten Type Slider Logic
        shortenTypeSlider.addEventListener('click', () => {
            isIframeShorten = !isIframeShorten;
            sliderThumb.classList.toggle('iframe', isIframeShorten);
            sliderThumb.innerHTML = isIframeShorten 
                ? '<i class="fa-solid fa-check mr-2"></i> Iframe Shorten' 
                : '<i class="fa-solid fa-check mr-2"></i> Basic Shorten';
            sliderThumb.classList.toggle('bg-green-500', !isIframeShorten);
            sliderThumb.classList.toggle('bg-blue-600', isIframeShorten);
        });

        // Edit/Delete Logic
        document.addEventListener('click', async (e) => {
            if (e.target.classList.contains('edit-btn')) {
                const docId = e.target.dataset.id;
                const docRef = doc(db, `artifacts/${appId}/public/data/short_urls`, docId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // Permission check: only owner or admin can edit
                    if (data.createdBy !== userId && !isAdmin()) {
                         showMessage("You do not have permission to edit this link.");
                         return;
                    }

                    document.getElementById('edit-doc-id').value = docId;
                    document.getElementById('edit-long-url').value = data.longUrl;
                    document.getElementById('edit-custom-domain').value = data.shortCode;
                    document.getElementById('edit-expiry-date').value = data.expiryDate || '';
                    document.getElementById('edit-modal-owner').textContent = `Owner: ${data.createdBy === userId ? 'You' : (data.createdBy ? data.createdBy.substring(0, 5) : 'Anonim')}`;
                    editModal.classList.remove('hidden');
                }
            }
            if (e.target.classList.contains('delete-btn')) {
                const docId = e.target.dataset.id;
                 const docRef = doc(db, `artifacts/${appId}/public/data/short_urls`, docId);
                 const docSnap = await getDoc(docRef);
                 if (docSnap.exists() && docSnap.data().createdBy !== userId && !isAdmin()) {
                     showMessage("You do not have permission to delete this link.");
                     return;
                 }

                if (confirm('Are you sure you want to delete this link?')) {
                    try {
                        await deleteDoc(docRef);
                        showMessage("Link successfully deleted!");
                    } catch (e) {
                        console.error("Error removing document: ", e);
                        showMessage("Failed to delete link.");
                    }
                }
            }
        });

        document.getElementById('save-edit-button').addEventListener('click', async () => {
            const docId = document.getElementById('edit-doc-id').value;
            const newLongUrl = document.getElementById('edit-long-url').value.trim();
            const newCustomDomain = normalizeSlug(document.getElementById('edit-custom-domain').value.trim());
            const newExpiryDate = document.getElementById('edit-expiry-date').value;

            if (!newLongUrl) {
                showMessage("Original URL cannot be empty.");
                return;
            }

            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/short_urls`, docId);
                await updateDoc(docRef, {
                    longUrl: newLongUrl,
                    // Note: Changing the shortCode here is risky as it changes the document ID in Firestore.
                    // For safety in this simplified model, we will only update other fields.
                    // If you must allow changing the slug, you would need to delete the old doc and create a new one.
                    expiryDate: newExpiryDate || null,
                });
                editModal.classList.add('hidden');
                showMessage("Link successfully updated!");
            } catch (e) {
                console.error("Error updating document: ", e);
                showMessage("Failed to update link.");
            }
        });

        document.getElementById('cancel-edit-button').addEventListener('click', () => {
            editModal.classList.add('hidden');
        });

        // Copy Button Listener
        copyButton.addEventListener('click', () => {
            const urlToCopy = shortUrlOutput.textContent;
            navigator.clipboard.writeText(urlToCopy).then(() => {
                showMessage("Link successfully copied to clipboard!");
            }).catch(err => {
                console.error('Failed to copy text: ', err);
                showMessage("Failed to copy link.");
            });
        });

        // Download QR Button Listener
        downloadQrButton.addEventListener('click', () => {
            const qrCanvas = qrcodeContainer.querySelector('canvas');
            if (qrCanvas) {
                const link = document.createElement('a');
                link.href = qrCanvas.toDataURL('image/png');
                link.download = `shareu-qr-${shortUrlOutput.textContent.split('/').pop()}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showMessage("QR Code successfully downloaded!");
            }
        });


        // Initial App Load
        window.addEventListener('load', initializeFirebase);
    </script>
</body>
</html>
